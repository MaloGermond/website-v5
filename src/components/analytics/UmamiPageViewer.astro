---
import { getUmamiConfig } from '@utils/umamiConfig';

const {url:pageSlug=undefined, name:pageName=undefined} = Astro.props
const config = getUmamiConfig();

const searchParams = new URLSearchParams(Astro.url.search);
const utmSource =  config.isDevMode ? "development" : searchParams.get('utm_source');
const utmMedium = searchParams.get('utm_medium');
const utmCampaign = searchParams.get('utm_campaign');
const utmTerm = searchParams.get('utm_term');
const utmContent = searchParams.get('utm_content');

---

<script is:inline>
  if (!config.isEnabled) {
    console.log('Umami - Page Viewer désactivé');
  } else {
    // Charge le script Umami via un endpoint API sécurisé
    fetch('/api/umami-script?pageSlug=${pageSlug || ''}&pageName=${pageName || ''}')
      .then(response => response.text())
      .then(script => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = script;
        document.head.appendChild(tempDiv.firstChild);
      })
      .catch(error => {
        console.error('Erreur de chargement du script Umami:', error);
      });
  }
</script>
